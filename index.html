<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Updated Title for SEO -->
    <title>AI Land Value & Feasibility Estimator | Commercial Property Analysis Tool</title>
    <!-- Added Meta Description for SEO -->
    <meta name="description" content="Analyze the commercial potential of any land plot with our AI-powered tool. Get an instant value score, nearby amenity reports, and a 5-year feasibility study summary. Ideal for real estate developers and investors.">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom styles for the app */
        body {
            font-family: 'Inter', sans-serif;
        }
        #map {
            height: 100%;
            width: 100%;
        }
        /* Custom styling for the info window content */
        .gm-style-iw {
            padding: 0 !important;
            border-radius: 8px !important;
        }
        .gm-style-iw-d {
            overflow: hidden !important;
        }
        .gm-style-iw-c {
            box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
            border-radius: 8px !important;
        }
        /* Styling for the AI summary placeholder */
        #ai-summary-content p:empty:before {
            content: "Click the generate button to get an AI-powered summary of the area's development trends, recent projects, and economic outlook based on data from the last 5 years.";
            color: #9ca3af;
            font-style: italic;
        }
    </style>
</head>
<body class="h-screen w-screen flex flex-col md:flex-row antialiased overflow-hidden">

    <!-- Sidebar for controls and results -->
    <div id="sidebar" class="w-full md:w-[400px] md:flex-shrink-0 h-1/2 md:h-full overflow-y-auto bg-white shadow-lg p-6 z-10">
        <div class="flex items-center justify-between mb-6">
            <!-- Updated Heading -->
            <h1 class="text-2xl font-bold text-gray-800">AI Land Analyzer</h1>
             <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-blue-500" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M5.05 3.05a7 7 0 000 9.9l4.95-4.95a7 7 0 00-9.9 0zM10 18a8 8 0 100-16 8 8 0 000 16zm-4.95-2.05a7 7 0 009.9 0L10 10.05l-4.95 5.9z" clip-rule="evenodd" />
            </svg>
        </div>

        <!-- Search Input -->
        <div class="mb-4 relative">
            <input id="pac-input" type="text" placeholder="Search for a location" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
             <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 absolute right-3 top-3.5 text-gray-400" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
            </svg>
        </div>
        
        <!-- Instructions -->
        <div id="instructions" class="bg-blue-50 border-l-4 border-blue-400 p-4 rounded-r-lg mb-6">
            <h3 class="font-bold text-blue-800">How to use:</h3>
            <ol class="list-decimal list-inside text-sm text-blue-700 mt-2 space-y-1">
                <li>Search for a location or pan the map.</li>
                <li>Use the polygon tool <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block" viewBox="0 0 20 20" fill="currentColor"><path d="M15 3H5a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2V5a2 2 0 00-2-2zm-1 2v2H6V5h8zM6 9h8v2H6V9zm0 4h8v2H6v-2z" /></svg> to draw the plot of land.</li>
                <li>The analysis will appear below automatically.</li>
            </ol>
        </div>

        <!-- Results Panel -->
        <div id="results-panel" class="hidden border rounded-lg">
             <div id="analysis-header" class="flex justify-between items-center cursor-pointer p-3 bg-gray-50 rounded-t-lg">
                <h2 class="text-xl font-bold text-gray-800">Analysis Report</h2>
                <svg id="analysis-chevron" class="h-6 w-6 text-gray-600 transform transition-transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
            </div>
           
            <div id="analysis-body" class="p-4 space-y-4">
                <p class="text-sm text-gray-500">Based on the selected area.</p>

                <!-- Loading Spinner -->
                <div id="loading" class="hidden items-center justify-center py-8">
                     <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"></div>
                     <p class="ml-4 text-gray-600">Analyzing...</p>
                </div>
               
                <div id="analysis-content">
                    <!-- Score Card -->
                    <div class="bg-gradient-to-br from-blue-500 to-indigo-600 text-white p-6 rounded-xl shadow-lg text-center">
                        <h3 class="text-lg font-medium opacity-80">Commercial Potential Score</h3>
                        <p id="score" class="text-5xl font-bold my-2">0</p>
                        <p id="score-description" class="text-sm opacity-90"></p>
                    </div>
                    
                    <!-- Area Card -->
                    <div class="bg-white p-4 rounded-lg shadow-md mt-4 border">
                        <h4 class="font-semibold text-gray-700">Land Area</h4>
                        <p id="area" class="text-2xl font-bold text-gray-900">0 m²</p>
                    </div>

                    <!-- POI Breakdown -->
                    <div class="bg-white p-4 rounded-lg shadow-md mt-4 border">
                        <h4 class="font-semibold text-gray-700 mb-3">Nearby Amenities (5km radius)</h4>
                        <div id="poi-list" class="space-y-2 text-sm"></div>
                    </div>

                    <!-- AI Feasibility Summary -->
                    <div class="bg-white rounded-lg shadow-md mt-4 border">
                        <div id="ai-summary-header" class="flex justify-between items-center cursor-pointer p-3 bg-gray-50 rounded-t-lg">
                           <h4 class="font-semibold text-gray-700">AI Feasibility Summary</h4>
                           <svg class="h-5 w-5 text-gray-500 transform transition-transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                        </div>
                        <div id="ai-summary-body" class="p-4 hidden">
                            <div id="ai-summary-content" class="text-sm text-gray-800 leading-relaxed"><p></p></div>
                             <div id="ai-loading" class="hidden items-center justify-center py-4">
                                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-500"></div>
                                <p class="ml-3 text-gray-600">Generating summary...</p>
                            </div>
                            <button id="generate-summary-button" class="mt-4 w-full bg-indigo-600 text-white py-2 px-4 rounded-lg hover:bg-indigo-700 transition duration-200 flex items-center justify-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" /></svg>
                                Generate Summary
                            </button>
                        </div>
                    </div>

                     <button id="clear-button" class="mt-6 w-full bg-red-500 text-white py-2.5 px-4 rounded-lg hover:bg-red-600 transition duration-200 flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" />
                        </svg>
                        Start New Analysis
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Map Container -->
    <div id="map-container" class="w-full h-full relative">
        <div id="map"></div>
    </div>
    
    <script>
        // --- GOOGLE MAPS API SCRIPT ---
        // IMPORTANT: Replace "YOUR_API_KEY" with your actual Google Maps API key.
        const API_KEY = "AIzaSyAuya9u6xPQlg7-5r60mivksXgemihnT4U"; 
        
        // --- GLOBAL VARIABLES ---
        let map;
        let drawingManager;
        let selectedShape;
        let infoWindow;
        let placesService;
        let geocoder;

        // --- MAP INITIALIZATION ---
        function initMap() {
            // Initial map center (Kajang, Selangor, Malaysia)
            const initialPos = { lat: 2.9935, lng: 101.7874 };

            // Create the map
            map = new google.maps.Map(document.getElementById('map'), {
                center: initialPos,
                zoom: 12,
                mapTypeId: 'roadmap',
                mapTypeControl: false,
                streetViewControl: false,
                fullscreenControl: false,
                styles: [ // Custom map styles for a cleaner look
                    { elementType: "geometry", stylers: [{ color: "#f5f5f5" }] },
                    { elementType: "labels.icon", stylers: [{ visibility: "off" }] },
                    { elementType: "labels.text.fill", stylers: [{ color: "#616161" }] },
                    { elementType: "labels.text.stroke", stylers: [{ color: "#f5f5f5" }] },
                    { featureType: "administrative.land_parcel", stylers: [{ visibility: "off" }] },
                    { featureType: "administrative.locality", elementType: "labels.text.fill", stylers: [{ color: "#bdbdbd" }] },
                    { featureType: "poi", elementType: "geometry", stylers: [{ color: "#eeeeee" }] },
                    { featureType: "poi", elementType: "labels.text.fill", stylers: [{ color: "#757575" }] },
                    { featureType: "poi.park", elementType: "geometry", stylers: [{ color: "#e5e5e5" }] },
                    { featureType: "poi.park", elementType: "labels.text.fill", stylers: [{ color: "#9e9e9e" }] },
                    { featureType: "road", elementType: "geometry", stylers: [{ color: "#ffffff" }] },
                    { featureType: "road.arterial", elementType: "labels.text.fill", stylers: [{ color: "#757575" }] },
                    { featureType: "road.highway", elementType: "geometry", stylers: [{ color: "#dadada" }] },
                    { featureType: "road.highway", elementType: "labels.text.fill", stylers: [{ color: "#616161" }] },
                    { featureType: "road.local", elementType: "labels.text.fill", stylers: [{ color: "#9e9e9e" }] },
                    { featureType: "transit.line", elementType: "geometry", stylers: [{ color: "#e5e5e5" }] },
                    { featureType: "transit.station", elementType: "geometry", stylers: [{ color: "#eeeeee" }] },
                    { featureType: "water", elementType: "geometry", stylers: [{ color: "#c9c9c9" }] },
                    { featureType: "water", elementType: "labels.text.fill", stylers: [{ color: "#9e9e9e" }] }
                ]
            });

            // Initialize Places and Geocoder Services
            placesService = new google.maps.places.PlacesService(map);
            geocoder = new google.maps.Geocoder();

            // Initialize Info Window
            infoWindow = new google.maps.InfoWindow();

            // --- SEARCH BOX ---
            const input = document.getElementById("pac-input");
            const searchBox = new google.maps.places.SearchBox(input);
            if (!document.getElementById('sidebar').getAttribute('data-pushed')) {
                 map.controls[google.maps.ControlPosition.TOP_LEFT].push(document.getElementById('sidebar'));
                 document.getElementById('sidebar').setAttribute('data-pushed', 'true');
            }


            map.addListener("bounds_changed", () => {
                searchBox.setBounds(map.getBounds());
            });

            searchBox.addListener("places_changed", () => {
                const places = searchBox.getPlaces();
                if (places.length == 0) return;

                const bounds = new google.maps.LatLngBounds();
                places.forEach((place) => {
                    if (!place.geometry || !place.geometry.location) return;
                    if (place.geometry.viewport) {
                        bounds.union(place.geometry.viewport);
                    } else {
                        bounds.extend(place.geometry.location);
                    }
                });
                map.fitBounds(bounds);
            });


            // --- DRAWING MANAGER ---
            drawingManager = new google.maps.drawing.DrawingManager({
                drawingMode: google.maps.drawing.OverlayType.POLYGON,
                drawingControl: true,
                drawingControlOptions: {
                    position: google.maps.ControlPosition.TOP_CENTER,
                    drawingModes: [
                        google.maps.drawing.OverlayType.POLYGON,
                    ],
                },
                polygonOptions: {
                    fillColor: '#4A90E2',
                    fillOpacity: 0.5,
                    strokeWeight: 2,
                    strokeColor: '#0000FF',
                    clickable: false,
                    editable: true,
                    zIndex: 1,
                },
            });
            drawingManager.setMap(map);


            // --- EVENT LISTENERS ---
            google.maps.event.addListener(drawingManager, 'overlaycomplete', function(event) {
                if (selectedShape) {
                    selectedShape.setMap(null);
                }
                
                selectedShape = event.overlay;
                selectedShape.type = event.type;
                
                drawingManager.setDrawingMode(null);
                
                document.getElementById('instructions').classList.add('hidden');
                document.getElementById('results-panel').classList.remove('hidden');
                document.getElementById('analysis-body').classList.remove('hidden');
                document.getElementById('analysis-chevron').classList.remove('rotate-180');
                document.getElementById('analysis-content').classList.add('hidden');
                document.getElementById('loading').classList.remove('hidden');

                // Reset AI Summary section
                document.getElementById('ai-summary-content').innerHTML = '<p></p>';
                document.getElementById('generate-summary-button').classList.remove('hidden');

                analyzeShape(selectedShape);
            });

            document.getElementById('clear-button').addEventListener('click', clearSelection);
            
            // Collapsible panel listeners
            document.getElementById('analysis-header').addEventListener('click', () => {
                document.getElementById('analysis-body').classList.toggle('hidden');
                document.getElementById('analysis-chevron').classList.toggle('rotate-180');
            });
            document.getElementById('ai-summary-header').addEventListener('click', () => {
                document.getElementById('ai-summary-body').classList.toggle('hidden');
                document.getElementById('ai-summary-header').querySelector('svg').classList.toggle('rotate-180');
            });

            document.getElementById('generate-summary-button').addEventListener('click', getFeasibilitySummary);

        }

        // --- ANALYSIS LOGIC ---
        async function analyzeShape(shape) {
            const path = shape.getPath();
            const vertices = path.getArray();

            // 1. Calculate Area and reset UI
            const areaInMeters = google.maps.geometry.spherical.computeArea(path);
            document.getElementById('area').innerText = `${areaInMeters.toFixed(2)} m²`;
            document.getElementById('poi-list').innerHTML = '';
            document.getElementById('score').innerText = '0';
            document.getElementById('score-description').innerText = '';
            
            // 2. Find Centroid for POI search
            const bounds = new google.maps.LatLngBounds();
            vertices.forEach(vertex => bounds.extend(vertex));
            const center = bounds.getCenter();

            // 3. Search for nearby POIs sequentially
            const poiTypes = {
                'Transit Station': ['transit_station'], 'Shopping': ['shopping_mall'],
                'Food & Drink': ['restaurant'], 'Education': ['school'],
                'Health': ['hospital'], 'Lodging': ['hotel'], 'Finance': ['bank'],
            };
            
            const poiData = {};
            let hasApiError = false;

            for (const category of Object.keys(poiTypes)) {
                const request = {
                    location: center, radius: '5000', types: poiTypes[category]
                };

                try {
                    const results = await new Promise((resolve, reject) => {
                        const timeoutId = setTimeout(() => reject(new Error('TIMEOUT')), 30000); 

                        placesService.nearbySearch(request, (res, status) => {
                            clearTimeout(timeoutId);
                            if (status === google.maps.places.PlacesServiceStatus.OK || status === google.maps.places.PlacesServiceStatus.ZERO_RESULTS) {
                                resolve(res || []);
                            } else {
                                reject(new Error(status));
                            }
                        });
                    });
                    poiData[category] = results;
                } catch (error) {
                    console.error(`Failed to fetch ${category}. Status: ${error.message}`);
                    hasApiError = true;
                    poiData[category] = [];
                    handleApiError(error.message, category);
                }
                
                // Update UI progressively
                displayPoiResults(poiData, center);
                const poiCounts = Object.keys(poiData).reduce((acc, key) => {
                    acc[key] = poiData[key].length;
                    return acc;
                }, {});
                calculateAndDisplayScore(areaInMeters, poiCounts);

                await new Promise(resolve => setTimeout(resolve, 250)); 
            }
            
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('analysis-content').classList.remove('hidden');

            if (Object.values(poiData).every(list => list.length === 0) && !hasApiError) {
                document.getElementById('poi-list').innerHTML = `<p class="text-gray-500 text-center p-4">No significant amenities found within a 5km radius.</p>`;
            }
        }
        
        // --- UI DISPLAY FUNCTIONS ---
        function displayPoiResults(poiData, polygonCenter) {
            const poiListContainer = document.getElementById('poi-list');
            poiListContainer.innerHTML = ''; // Clear and redraw on each update

            const sortedCategories = Object.keys(poiData)
                .sort((a, b) => poiData[b].length - poiData[a].length);

            sortedCategories.forEach(category => {
                const places = poiData[category];
                
                // Category Accordion
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'border-b';

                // Header
                const header = document.createElement('div');
                header.className = 'flex justify-between items-center p-2 cursor-pointer hover:bg-gray-50';
                header.innerHTML = `
                    <span class="font-semibold text-gray-700">${category}</span>
                    <div class="flex items-center space-x-2">
                        <span class="font-bold text-blue-600 bg-blue-100 px-2 py-0.5 rounded-full">${places.length}</span>
                        <svg class="h-5 w-5 text-gray-500 transform transition-transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                    </div>
                `;

                // Content
                const content = document.createElement('div');
                content.className = 'hidden pl-4 pr-2 pb-2 space-y-2';

                if (places.length > 0) {
                    places.forEach(place => {
                        const distance = google.maps.geometry.spherical.computeDistanceBetween(polygonCenter, place.geometry.location);
                        const distanceInKm = (distance / 1000).toFixed(2);
                        
                        const placeDiv = document.createElement('div');
                        placeDiv.className = 'flex justify-between items-center text-xs';
                        placeDiv.innerHTML = `
                            <span class="text-gray-600 truncate pr-2">${place.name}</span>
                            <span class="text-gray-500 font-medium whitespace-nowrap">${distanceInKm} km</span>
                        `;
                        content.appendChild(placeDiv);
                    });
                } else {
                    content.innerHTML = `<p class="text-xs text-gray-400 italic">No locations found for this category.</p>`;
                }

                // Click handler for accordion
                header.addEventListener('click', () => {
                    const isHidden = content.classList.contains('hidden');
                    poiListContainer.querySelectorAll('.accordion-content').forEach(c => c.classList.add('hidden'));
                    poiListContainer.querySelectorAll('.accordion-header svg').forEach(svg => svg.classList.remove('rotate-180'));
                    
                    if(isHidden) {
                        content.classList.remove('hidden');
                        header.querySelector('svg').classList.add('rotate-180');
                    }
                });
                
                header.classList.add('accordion-header');
                content.classList.add('accordion-content');
                categoryDiv.appendChild(header);
                categoryDiv.appendChild(content);
                poiListContainer.appendChild(categoryDiv);
            });
        }


        function calculateAndDisplayScore(area, poiCounts) {
             let score = 0;
            const poiWeights = {
                'Transit Station': 2.5, 'Shopping': 2.0, 'Food & Drink': 1.5,
                'Education': 1.2, 'Health': 1.2, 'Finance': 1.0, 'Lodging': 0.8,
            };

            for (const category in poiCounts) {
                score += (poiCounts[category] || 0) * (poiWeights[category] || 1);
            }

            let normalizedScore = Math.min(Math.round(score / 2), 100);
            if (area > 10000) { normalizedScore += Math.min(5, Math.log10(area/10000) * 5); }
            if (area > 50000) { normalizedScore += Math.min(5, Math.log10(area/50000) * 5); }
            normalizedScore = Math.min(Math.round(normalizedScore), 100);

            const scoreElement = document.getElementById('score');
            const descElement = document.getElementById('score-description');

            if (scoreElement.innerText === 'Error') return;

            scoreElement.innerText = normalizedScore;

            if (normalizedScore >= 85) { descElement.innerText = "Excellent commercial potential. High density of key amenities."; } 
            else if (normalizedScore >= 70) { descElement.innerText = "Very Good potential. Strong presence of valuable amenities.";} 
            else if (normalizedScore >= 50) { descElement.innerText = "Good potential. A solid mix of nearby services."; } 
            else if (normalizedScore >= 30) { descElement.innerText = "Moderate potential. Some amenities present, room for growth."; } 
            else { descElement.innerText = "Developing potential. Fewer commercial amenities nearby."; }
        }

        // --- AI SUMMARY ---
        async function getFeasibilitySummary() {
            if (!selectedShape) {
                alert("Please draw an area on the map first.");
                return;
            }
            const generateButton = document.getElementById('generate-summary-button');
            const summaryContent = document.getElementById('ai-summary-content');
            const aiLoading = document.getElementById('ai-loading');

            generateButton.classList.add('hidden');
            aiLoading.classList.remove('hidden');
            summaryContent.innerHTML = '';

            // Get location name
            const path = selectedShape.getPath();
            const bounds = new google.maps.LatLngBounds();
            path.getArray().forEach(vertex => bounds.extend(vertex));
            const center = bounds.getCenter();

            try {
                const geoResponse = await geocoder.geocode({ location: center });
                if (!geoResponse.results || geoResponse.results.length === 0) {
                   throw new Error("Could not determine the location name.");
                }

                // Find a useful location name from the results
                const locality = geoResponse.results[0].address_components.find(c => c.types.includes('locality') || c.types.includes('administrative_area_level_2') || c.types.includes('administrative_area_level_1'));
                const locationName = locality ? locality.long_name : geoResponse.results[0].formatted_address;

                // --- Call Gemini API ---
                const prompt = `Generate a commercial feasibility study summary for ${locationName} for the last 5 years. Use the following format exactly:\n\n**Major Development Projects:**\n- [Point 1]\n- [Point 2]\n\n**Economic & Population Trends:**\n- [Point 1]\n- [Point 2]\n\n**Infrastructure Improvements:**\n- [Point 1]\n- [Point 2]\n\n**Market Sentiment & Future Outlook:**\n- [Point 1]\n- [Point 2]`;
                let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                const payload = { contents: chatHistory };
                // *** FIX: Use the main API_KEY for the Gemini call as well ***
                const geminiApiKey = API_KEY; 
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${geminiApiKey}`;

                const apiResponse = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!apiResponse.ok) {
                    throw new Error(`API request failed with status ${apiResponse.status}`);
                }

                const result = await apiResponse.json();
                
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    // Convert markdown-like response to HTML list
                    const html = text
                        .replace(/\*\*(.*?)\*\*/g, '<h5 class="font-semibold text-gray-800 mt-4 mb-2">$1</h5>') // Headings
                        .replace(/(\n|^)[\*|-]\s/g, '<li>') // List items
                        .split('<li>')
                        .map((item, index) => index === 0 ? item : `<li class="ml-4 list-disc">${item.trim()}</li>`)
                        .join('')
                        .replace(/<\/li>(\s*<h5)/g, '</li></ul>$1') // Close UL before next heading
                        .replace(/(<h5>.*?<\/h5>)/g, '$1<ul>') + '</ul>'; // Start UL after heading
                    
                    summaryContent.innerHTML = html.replace(/<ul><\/ul>/g, ''); // Clean up empty lists

                } else {
                    throw new Error("The AI model returned no content.");
                }

            } catch (error) {
                console.error("Feasibility summary error:", error);
                let userErrorMessage = `<p class="text-red-500">Could not generate the feasibility summary. Error: ${error.message}</p>`;

                if (error.message && (error.message.includes('REQUEST_DENIED') || error.message.includes('GEOCODER_GEOCODE'))) {
                    userErrorMessage = `
                        <div class="api-error bg-red-100 border-l-4 border-red-500 text-red-800 p-4 rounded-lg my-2" role="alert">
                            <p class="font-bold">API Key Error: Geocoding API Not Enabled</p>
                            <p class="mt-2">To generate the AI summary, this application needs to identify the name of the location you selected.</p>
                            <p class="mt-2">Your Google Maps API key is not authorized to use the <strong>Geocoding API</strong>.</p>
                            <p class="mt-2 text-sm"><strong>How to fix:</strong></p>
                            <ol class="list-decimal list-inside mt-1 space-y-1 text-sm">
                                <li>Go to your <a href="https://console.cloud.google.com/" target="_blank" class="underline font-semibold">Google Cloud Console</a>.</li>
                                <li>Navigate to "APIs & Services" > "Library".</li>
                                <li>Search for "Geocoding API" and click "Enable".</li>
                                <li>If you have restricted your API key, make sure to add "Geocoding API" to the list of allowed APIs.</li>
                            </ol>
                        </div>
                    `;
                }
                summaryContent.innerHTML = userErrorMessage;
                generateButton.classList.remove('hidden');
            } finally {
                aiLoading.classList.add('hidden');
            }
        }


        // --- ERROR HANDLING & UTILITIES ---
        function handleApiError(status, category) {
            const poiList = document.getElementById('poi-list');
            const errorId = `api-error-${category.replace(/\s+/g, '-')}`;
            if (document.getElementById(errorId)) return; 

            let errorMessage = '';

            if (status === google.maps.places.PlacesServiceStatus.REQUEST_DENIED) {
                 errorMessage = `
                    <div id="${errorId}" class="api-error bg-red-100 border-l-4 border-red-500 text-red-800 p-4 rounded-lg my-2" role="alert">
                        <p class="font-bold">API Key Error: Website Not Authorized</p>
                        <p class="mt-2">Your API key's security settings are preventing this website from using Google Maps services.</p>
                        <p class="mt-2 text-sm"><strong>How to fix:</strong></p>
                        <ol class="list-decimal list-inside mt-1 space-y-1 text-sm">
                            <li>Go to your <a href="https://console.cloud.google.com/" target="_blank" class="underline font-semibold">Google Cloud Console</a>.</li>
                            <li>Navigate to "APIs & Services" > "Credentials".</li>
                            <li>Find your API key and click the edit icon (pencil).</li>
                            <li>Under "Application restrictions", find the "HTTP referrers (web sites)" list.</li>
                            <li>Click "ADD AN ITEM" and enter the URL of the website where you are using this app.</li>
                            <li class="mt-1">Your site's URL to add is: <br><strong class="break-all">${window.location.origin}</strong></li>
                            <li class="mt-1">For a wildcard, add: <br><strong class="break-all">${window.location.origin}/*</strong></li>
                        </ol>
                    </div>
                `;
            } else if (status === 'TIMEOUT') {
                errorMessage = `<div id="${errorId}" class="api-error bg-yellow-100 border-l-4 border-yellow-500 text-yellow-800 p-4 rounded-lg my-2" role="alert"><p class="font-bold">Analysis Timed Out</p><p>The search for '${category}' took too long. The analysis will continue but may be incomplete.</p></div>`;
            } else if (status === google.maps.places.PlacesServiceStatus.OVER_QUERY_LIMIT) {
                errorMessage = `<div id="${errorId}" class="api-error bg-yellow-100 border-l-4 border-yellow-500 text-yellow-800 p-4 rounded-lg my-2" role="alert"><p class="font-bold">Usage Limit Reached</p><p>You have exceeded the free usage quota. Analysis is incomplete.</p></div>`;
            } else {
                 errorMessage = `<div id="${errorId}" class="api-error bg-red-100 border-l-4 border-red-500 text-red-800 p-4 rounded-lg my-2" role="alert"><p class="font-bold">Network Error</p><p>Could not fetch '${category}' due to an API issue (Status: ${status}).</p></div>`;
            }

            poiList.insertAdjacentHTML('afterbegin', errorMessage);
            document.getElementById('score').innerText = 'Error';
            document.getElementById('score-description').innerText = 'Analysis is incomplete.';
        }

        function clearSelection() {
            if (selectedShape) {
                selectedShape.setMap(null);
                selectedShape = null;
            }
            
            document.getElementById('results-panel').classList.add('hidden');
            document.getElementById('instructions').classList.remove('hidden');
            drawingManager.setDrawingMode(google.maps.drawing.OverlayType.POLYGON);
        }
        
        // --- LOAD THE MAP SCRIPT ---
        function loadMapScript() {
            if (API_KEY === "YOUR_API_KEY" || !API_KEY) {
                document.getElementById('map').innerHTML = `
                    <div class="flex items-center justify-center h-full bg-gray-200">
                        <div class="text-center p-8 bg-white rounded-lg shadow-md">
                            <h2 class="text-2xl font-bold text-red-600 mb-4">API Key Required</h2>
                            <p class="text-gray-700">Please replace <strong>"YOUR_API_KEY"</strong> in the JavaScript code with your actual Google Maps API key to use this application.</p>
                        </div>
                    </div>
                `;
                return;
            }
            const script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=${API_KEY}&libraries=places,drawing,geometry&callback=initMap`;
            script.async = true;
            script.defer = true;
            document.head.appendChild(script);
        }

        window.onload = loadMapScript;

    </script>
</body>
</html>
