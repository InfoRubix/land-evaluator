<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Updated Title for SEO -->
    <title>AI Land Value & Feasibility Estimator | Commercial Property Analysis Tool</title>
    <!-- Added Meta Description for SEO -->
    <meta name="description" content="Analyze the commercial potential of any land plot with our AI-powered tool. Get an instant value score, nearby amenity reports, and a 5-year feasibility study summary. Ideal for real estate developers and investors.">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- PDF Generation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom styles for the app */
        body {
            font-family: 'Inter', sans-serif;
        }
        #map {
            height: 100%;
            width: 100%;
        }
        /* Custom styling for the info window content */
        .gm-style-iw {
            padding: 0 !important;
            border-radius: 8px !important;
        }
        .gm-style-iw-d {
            overflow: hidden !important;
        }
        .gm-style-iw-c {
            box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
            border-radius: 8px !important;
        }
        /* Styling for the AI summary placeholder */
        #ai-summary-content p:empty:before, 
        #property-valuation-content p:empty:before,
        #seller-pitch-content p:empty:before {
            content: "Click the generate button to get an AI-powered analysis.";
            color: #9ca3af;
            font-style: italic;
        }
    </style>
</head>
<body class="h-screen w-screen flex flex-col md:flex-row antialiased overflow-hidden">

    <!-- Sidebar for controls and results -->
    <div id="sidebar" class="w-full md:w-[450px] md:flex-shrink-0 h-1/2 md:h-full overflow-y-auto bg-white shadow-lg p-6 z-10">
        <div class="flex items-start justify-between mb-6">
            <div>
                <!-- Updated Heading -->
                <h1 class="text-2xl font-bold text-gray-800">AI Property Analyzer</h1>
                <!-- Added Subtitle -->
                <p class="text-xs text-gray-500">Powered by RBX</p>
            </div>
             <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-blue-500 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M5.05 3.05a7 7 0 000 9.9l4.95-4.95a7 7 0 00-9.9 0zM10 18a8 8 0 100-16 8 8 0 000 16zm-4.95-2.05a7 7 0 009.9 0L10 10.05l-4.95 5.9z" clip-rule="evenodd" />
            </svg>
        </div>

        <!-- Agent Details for PDF -->
        <div class="mb-4 p-3 bg-gray-50 rounded-lg border">
            <h3 class="font-semibold text-gray-700 mb-2">Agent Details (for PDF Reports)</h3>
            <div class="space-y-2">
                <input id="agent-name" type="text" placeholder="Your Name" class="w-full text-sm px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500">
                <input id="agent-contact" type="text" placeholder="Contact No. / Email" class="w-full text-sm px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500">
            </div>
        </div>
        
        <!-- Mode Switcher -->
        <div class="mb-4">
             <label class="text-sm font-medium text-gray-700">Analysis Mode</label>
            <div class="mt-2 grid grid-cols-3 gap-1 rounded-lg bg-gray-200 p-1">
                <button id="mode-property" class="px-3 py-2 text-sm font-semibold rounded-md transition-colors">Valuation</button>
                <button id="mode-land" class="px-3 py-2 text-sm font-semibold rounded-md transition-colors">Land</button>
                <button id="mode-seller" class="px-3 py-2 text-sm font-semibold rounded-md transition-colors">Seller Pitch</button>
            </div>
        </div>

        <!-- Map View Switcher -->
        <div class="mb-4">
             <label class="text-sm font-medium text-gray-700">Map View</label>
            <div class="mt-2 grid grid-cols-2 gap-2 rounded-lg bg-gray-200 p-1">
                <button id="view-map" class="px-3 py-2 text-sm font-semibold rounded-md transition-colors">Map</button>
                <button id="view-satellite" class="px-3 py-2 text-sm font-semibold rounded-md transition-colors">Satellite</button>
            </div>
        </div>

        <!-- Search Input -->
        <div class="mb-4 relative">
            <input id="pac-input" type="text" placeholder="Search for a location or address" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
             <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 absolute right-3 top-3.5 text-gray-400" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
            </svg>
        </div>
        
        <!-- Instructions / Notification Panel -->
        <div id="instructions" class="bg-blue-50 border-l-4 border-blue-400 p-4 rounded-r-lg mb-6 transition-all duration-300">
            <h3 id="instructions-header" class="font-bold text-blue-800">How to use:</h3>
            <div id="instructions-body">
                 <!-- Instructions will be dynamically set by JS -->
            </div>
        </div>

        <!-- Panels Container -->
        <div id="panels-container">
            <!-- Property Valuation Panel -->
            <div id="property-valuation-panel" class="hidden analysis-panel border rounded-lg">
                <div class="flex justify-between items-center p-3 bg-green-50 rounded-t-lg">
                    <h2 class="text-xl font-bold text-gray-800">Property Valuation</h2>
                </div>
                <div class="p-4 space-y-4">
                    <p id="property-address" class="font-semibold text-gray-700 bg-gray-100 p-2 rounded-md"></p>
                    <div id="property-valuation-content" class="text-sm text-gray-800 leading-relaxed border-t pt-4"><p></p></div>
                    <div id="property-loading" class="hidden items-center justify-center py-4">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-green-500"></div>
                        <p class="ml-3 text-gray-600">Estimating market value...</p>
                    </div>
                    <button id="generate-valuation-button" class="w-full bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition duration-200 flex items-center justify-center">
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path d="M8.433 7.418c.158-.103.346-.195.574-.277a6.991 6.991 0 015.988 0c.228.082.416.174.574.277a1 1 0 01.582.946l.553 4.148a1 1 0 01-.29 1.003l-2.433 2.14a1 1 0 01-1.282-.14l-1.38-1.724a1 1 0 00-1.282 0l-1.38 1.724a1 1 0 01-1.282.14l-2.433-2.14a1 1 0 01-.29-1.003l.553-4.148a1 1 0 01.582-.946z" /><path fill-rule="evenodd" d="M12 2a1 1 0 011 1v1.333a4.002 4.002 0 013.307 2.334a1 1 0 01-.453 1.333l-4.251 2.834a1 1 0 01-1.21 0L6.406 8.001a1 1 0 01-.453-1.333A4.002 4.002 0 019 4.333V3a1 1 0 011-1h2z" clip-rule="evenodd" /></svg>
                        Estimate Market Value
                    </button>
                </div>
            </div>

             <!-- Seller Pitch Panel -->
            <div id="seller-pitch-panel" class="hidden analysis-panel border rounded-lg">
                <div class="flex justify-between items-center p-3 bg-purple-50 rounded-t-lg">
                    <h2 class="text-xl font-bold text-gray-800">Seller Pitch Report</h2>
                </div>
                <div class="p-4 space-y-4">
                    <p id="seller-address" class="font-semibold text-gray-700 bg-gray-100 p-2 rounded-md"></p>
                    <div id="seller-pitch-content" class="text-sm text-gray-800 leading-relaxed border-t pt-4"><p></p></div>
                    <div id="seller-loading" class="hidden items-center justify-center py-4">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-purple-500"></div>
                        <p class="ml-3 text-gray-600">Generating seller pitch...</p>
                    </div>
                    <button id="generate-pitch-button" class="w-full bg-purple-600 text-white py-2 px-4 rounded-lg hover:bg-purple-700 transition duration-200 flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path d="M10 9a3 3 0 100-6 3 3 0 000 6zM6 8a2 2 0 11-4 0 2 2 0 014 0zM1.49 15.326a.78.78 0 01-.358-.442 3 3 0 014.308-3.516 6.484 6.484 0 00-1.905 3.959c-.023.222-.014.442.025.654a4.97 4.97 0 01-2.07-.655zM16.44 15.98a4.97 4.97 0 002.07-.654.78.78 0 00.358-.442 3 3 0 00-4.308-3.517 6.484 6.484 0 011.905 3.96 2.074 2.074 0 01-.025.654zM12 10a4 4 0 110-8 4 4 0 010 8zm0 2a2 2 0 100 4 2 2 0 000-4z" /></svg>
                        Generate Pitch
                    </button>
                </div>
            </div>

            <!-- Land Analysis Panel -->
            <div id="results-panel" class="hidden analysis-panel border rounded-lg">
                 <div id="analysis-header" class="flex justify-between items-center cursor-pointer p-3 bg-gray-50 rounded-t-lg">
                    <h2 class="text-xl font-bold text-gray-800">Land Analysis Report</h2>
                    <svg id="analysis-chevron" class="h-6 w-6 text-gray-600 transform transition-transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                </div>
                <div id="analysis-body" class="p-4 space-y-4">
                    <p class="text-sm text-gray-500">Based on the selected area.</p>
                    <div id="loading" class="hidden items-center justify-center py-8">
                         <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"></div>
                         <p class="ml-4 text-gray-600">Analyzing...</p>
                    </div>
                    <div id="analysis-content">
                        <div class="bg-gradient-to-br from-blue-500 to-indigo-600 text-white p-6 rounded-xl shadow-lg text-center">
                            <h3 class="text-lg font-medium opacity-80">Commercial Potential Score</h3>
                            <p id="score" class="text-5xl font-bold my-2">0</p>
                            <p id="score-description" class="text-sm opacity-90"></p>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow-md mt-4 border">
                            <h4 class="font-semibold text-gray-700">Land Area</h4>
                            <p id="area" class="text-2xl font-bold text-gray-900">0 mÂ²</p>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow-md mt-4 border">
                            <h4 class="font-semibold text-gray-700 mb-3">Nearby Amenities (5km radius)</h4>
                            <div id="poi-list" class="space-y-2 text-sm"></div>
                        </div>
                        <div class="bg-white rounded-lg shadow-md mt-4 border">
                            <div id="ai-summary-header" class="flex justify-between items-center cursor-pointer p-3 bg-gray-50 rounded-t-lg">
                               <h4 class="font-semibold text-gray-700">AI Feasibility Summary</h4>
                               <svg class="h-5 w-5 text-gray-500 transform transition-transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                            </div>
                            <div id="ai-summary-body" class="p-4 hidden">
                                <div id="ai-summary-content" class="text-sm text-gray-800 leading-relaxed"><p></p></div>
                                 <div id="ai-loading" class="hidden items-center justify-center py-4">
                                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-500"></div>
                                    <p class="ml-3 text-gray-600">Generating summary...</p>
                                </div>
                                <button id="generate-summary-button" class="mt-4 w-full bg-indigo-600 text-white py-2 px-4 rounded-lg hover:bg-indigo-700 transition duration-200 flex items-center justify-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" /></svg>
                                    Generate Summary
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
             <button id="generate-pdf-button" class="mt-4 w-full bg-gray-700 text-white py-2.5 px-4 rounded-lg hover:bg-gray-800 transition duration-200 flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6 2a2 2 0 00-2 2v12a2 2 0 002 2h8a2 2 0 002-2V7.414A2 2 0 0015.414 6L12 2.586A2 2 0 0010.586 2H6zm5 6a1 1 0 10-2 0v3.586l-1.293-1.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V8z" clip-rule="evenodd" /></svg>
                Generate PDF Report
            </button>
        </div>
        
        <button id="clear-button" class="hidden mt-6 w-full bg-red-500 text-white py-2.5 px-4 rounded-lg hover:bg-red-600 transition duration-200 flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
            Start New Analysis
        </button>
    </div>

    <!-- Map Container -->
    <div id="map-container" class="w-full h-full relative">
        <div id="map"></div>
    </div>
    
    <script>
        // --- GLOBAL VARIABLES & INITIALIZATION ---
        const { jsPDF } = window.jspdf;
        const API_KEY = "AIzaSyAWBj5Dd0YiYCD0bsaZ8RJSjWrvLpW__NQ";
        let map, drawingManager, selectedShape, addressMarker, lastSearchedPlace, placesService, geocoder, currentMode = 'property', mapClickListener, poiMarker, poiLine, poiInfoWindow;
        
        window.onload = loadMapScript;

        function initMap() {
            const initialPos = { lat: 2.9935, lng: 101.7874 };
            map = new google.maps.Map(document.getElementById('map'), {
                center: initialPos, zoom: 12, mapTypeId: 'roadmap', mapTypeControl: false, streetViewControl: false, fullscreenControl: false,
                styles: [ { elementType: "geometry", stylers: [{ color: "#f5f5f5" }] }, { elementType: "labels.icon", stylers: [{ visibility: "off" }] }, { elementType: "labels.text.fill", stylers: [{ color: "#616161" }] }, { elementType: "labels.text.stroke", stylers: [{ color: "#f5f5f5" }] }, { featureType: "road", elementType: "geometry", stylers: [{ color: "#ffffff" }] }, { featureType: "water", elementType: "geometry", stylers: [{ color: "#c9c9c9" }] }, ]
            });

            placesService = new google.maps.places.PlacesService(map);
            geocoder = new google.maps.Geocoder();
            poiInfoWindow = new google.maps.InfoWindow();

            const input = document.getElementById("pac-input");
            const searchBox = new google.maps.places.SearchBox(input);
            if (!document.getElementById('sidebar').getAttribute('data-pushed')) {
                 map.controls[google.maps.ControlPosition.TOP_LEFT].push(document.getElementById('sidebar'));
                 document.getElementById('sidebar').setAttribute('data-pushed', 'true');
            }

            searchBox.addListener("places_changed", () => {
                const places = searchBox.getPlaces();
                if (places.length == 0) return;
                
                const place = places[0];
                if (!place.geometry || !place.geometry.location) return;

                clearSelection(true); 
                lastSearchedPlace = place;
                
                setAnalysisMode(place.types.includes('street_address') || place.types.includes('premise') ? 'property' : 'seller'); 
                analyzeAddress(place);
                
                const bounds = new google.maps.LatLngBounds();
                if (place.geometry.viewport) bounds.union(place.geometry.viewport); else bounds.extend(place.geometry.location);
                map.fitBounds(bounds);
                if (place.types.includes('street_address') || place.types.includes('premise')) map.setZoom(18); 
            });

            drawingManager = new google.maps.drawing.DrawingManager({
                drawingMode: null, drawingControl: false, 
                drawingControlOptions: { position: google.maps.ControlPosition.TOP_CENTER, drawingModes: [google.maps.drawing.OverlayType.POLYGON] },
                polygonOptions: { fillColor: '#4A90E2', fillOpacity: 0.5, strokeWeight: 2, strokeColor: '#0000FF', clickable: false, editable: true, zIndex: 1 }
            });
            drawingManager.setMap(map);

            google.maps.event.addListener(drawingManager, 'overlaycomplete', function(event) {
                clearSelection(true);
                selectedShape = event.overlay;
                drawingManager.setDrawingMode(null);
                
                document.getElementById('instructions').classList.add('hidden');
                document.getElementById('results-panel').classList.remove('hidden');
                document.getElementById('analysis-body').classList.remove('hidden');
                document.getElementById('analysis-chevron').classList.remove('rotate-180');
                document.getElementById('analysis-content').classList.add('hidden');
                document.getElementById('loading').classList.remove('hidden');
                document.getElementById('clear-button').classList.remove('hidden');

                document.getElementById('ai-summary-content').innerHTML = '<p></p>';
                document.getElementById('generate-summary-button').classList.remove('hidden');
                analyzeShape(selectedShape);
            });

            // --- EVENT LISTENERS ---
            document.getElementById('clear-button').addEventListener('click', clearSelection);
            document.getElementById('mode-property').addEventListener('click', () => setAnalysisMode('property'));
            document.getElementById('mode-land').addEventListener('click', () => setAnalysisMode('land'));
            document.getElementById('mode-seller').addEventListener('click', () => setAnalysisMode('seller'));
            document.getElementById('view-map').addEventListener('click', () => setMapView('roadmap'));
            document.getElementById('view-satellite').addEventListener('click', () => setMapView('hybrid'));
            document.getElementById('analysis-header').addEventListener('click', () => {
                document.getElementById('analysis-body').classList.toggle('hidden');
                document.getElementById('analysis-chevron').classList.toggle('rotate-180');
            });
            document.getElementById('ai-summary-header').addEventListener('click', () => {
                document.getElementById('ai-summary-body').classList.toggle('hidden');
                document.getElementById('ai-summary-header').querySelector('svg').classList.toggle('rotate-180');
            });
            document.getElementById('generate-summary-button').addEventListener('click', getFeasibilitySummary);
            document.getElementById('generate-valuation-button').addEventListener('click', getMarketValueEstimate);
            document.getElementById('generate-pitch-button').addEventListener('click', getSellerPitch);
            document.getElementById('generate-pdf-button').addEventListener('click', generatePDF);
            
            setAnalysisMode('property');
            setMapView('roadmap');
        }

        // --- MODE & VIEW SWITCHING ---
        function setMapView(view) {
            map.setMapTypeId(view);
            document.getElementById('view-map').classList.toggle('bg-white', view === 'roadmap');
            document.getElementById('view-satellite').classList.toggle('bg-white', view === 'hybrid');
        }
        
        function setAnalysisMode(mode) {
            clearSelection(true); 
            currentMode = mode;
            
            ['property', 'land', 'seller'].forEach(m => {
                document.getElementById(`mode-${m}`).classList.toggle('bg-white', m === mode);
                document.getElementById(`mode-${m}`).classList.toggle('text-blue-700', m === mode);
                document.getElementById(`mode-${m}`).classList.toggle('shadow', m === mode);
            });

            if (mapClickListener) mapClickListener.remove();
            
            if (mode === 'land') {
                drawingManager.setOptions({ drawingControl: true });
                document.getElementById('instructions-body').innerHTML = `<ol class="list-decimal list-inside text-sm text-blue-700 mt-2 space-y-1"><li>Use the polygon tool to draw a shape.</li><li>The land analysis report will appear automatically.</li></ol>`;
            } else { // property or seller mode
                drawingManager.setOptions({ drawingControl: false, drawingMode: null });
                mapClickListener = map.addListener('click', handleMapClickForProperty);
                const modeText = mode === 'property' ? 'valuation' : 'seller pitch';
                document.getElementById('instructions-body').innerHTML = `<ol class="list-decimal list-inside text-sm text-blue-700 mt-2 space-y-1"><li>Search for a property address.</li><li>Or, click directly on a property on the map.</li><li>The ${modeText} panel will appear automatically.</li></ol>`;
            }
        }
        
        function handleMapClickForProperty(e) {
            if (e.placeId) { e.stop(); return; }
            geocoder.geocode({ location: e.latLng }, (results, status) => {
                if (status === 'OK' && results[0]) {
                    const place = results[0];
                    const invalidTypes = ['natural_feature', 'park', 'airport', 'route'];
                    if (place.types.some(type => invalidTypes.includes(type))) {
                        showNotification('Invalid selection. Please click on a building or property.', 'error');
                        return;
                    }

                    clearSelection(true);
                    lastSearchedPlace = place;
                    analyzeAddress(place);
                    
                    map.panTo(e.latLng);
                    if (window.innerWidth >= 768) map.panBy(-225, 0); 
                } else {
                    console.error('Geocode was not successful: ' + status);
                }
            });
        }


        // --- ANALYSIS LOGIC ---
        function analyzeAddress(place) {
            document.getElementById('instructions').classList.add('hidden');
            const targetPanel = currentMode === 'property' ? 'property-valuation-panel' : 'seller-pitch-panel';
            const addressField = currentMode === 'property' ? 'property-address' : 'seller-address';
            const contentField = currentMode === 'property' ? 'property-valuation-content' : 'seller-pitch-content';
            const generateButton = currentMode === 'property' ? 'generate-valuation-button' : 'generate-pitch-button';
            const loadingSpinner = currentMode === 'property' ? 'property-loading' : 'seller-loading';

            document.querySelectorAll('.analysis-panel').forEach(p => p.classList.add('hidden'));
            document.getElementById(targetPanel).classList.remove('hidden');
            document.getElementById('clear-button').classList.remove('hidden');
            document.getElementById(addressField).textContent = place.formatted_address;
            document.getElementById(contentField).innerHTML = '<p></p>';
            
            document.getElementById(generateButton).classList.remove('hidden');
            document.getElementById(loadingSpinner).classList.add('hidden');
            
            if(addressMarker) addressMarker.setMap(null);
            addressMarker = new google.maps.Marker({ map, position: place.geometry.location });
        }
        
        async function analyzeShape(shape) { /* ... same logic ... */ }
        
        // --- UI & REPORTING ---
        function displayPoiResults(poiData, centerPoint) {
            const poiListContainer = document.getElementById('poi-list');
            poiListContainer.innerHTML = ''; 

            const sortedCategories = Object.keys(poiData).sort((a, b) => poiData[b].length - poiData[a].length);
            sortedCategories.forEach(category => {
                const places = poiData[category];
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'border-b';
                const header = document.createElement('div');
                header.className = 'flex justify-between items-center p-2 cursor-pointer hover:bg-gray-50 accordion-header';
                header.innerHTML = `
                    <span class="font-semibold text-gray-700">${category}</span>
                    <div class="flex items-center space-x-2">
                        <span class="font-bold text-blue-600 bg-blue-100 px-2 py-0.5 rounded-full">${places.length}</span>
                        <svg class="h-5 w-5 text-gray-500 transform transition-transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                    </div>`;
                const content = document.createElement('div');
                content.className = 'hidden pl-4 pr-2 pb-2 space-y-2 accordion-content';
                if (places.length > 0) {
                    places.forEach(place => {
                        const distance = google.maps.geometry.spherical.computeDistanceBetween(centerPoint, place.geometry.location);
                        const distanceInKm = (distance / 1000).toFixed(2);
                        const placeDiv = document.createElement('div');
                        placeDiv.className = 'flex justify-between items-center text-xs p-1 rounded-md cursor-pointer hover:bg-gray-200';
                        placeDiv.innerHTML = `<span class="text-gray-600 truncate pr-2">${place.name}</span> <span class="text-gray-500 font-medium whitespace-nowrap">${distanceInKm} km</span>`;
                        placeDiv.addEventListener('click', () => showPoiOnMap(place, centerPoint));
                        content.appendChild(placeDiv);
                    });
                } else {
                    content.innerHTML = `<p class="text-xs text-gray-400 italic">No locations found.</p>`;
                }
                header.addEventListener('click', () => { /* Accordion logic */ });
                categoryDiv.appendChild(header);
                categoryDiv.appendChild(content);
                poiListContainer.appendChild(categoryDiv);
            });
        }
        
        function showPoiOnMap(place, centerPoint) {
            if (poiMarker) poiMarker.setMap(null);
            if (poiLine) poiLine.setMap(null);
            
            poiMarker = new google.maps.Marker({ position: place.geometry.location, map, icon: { url: "http://maps.google.com/mapfiles/ms/icons/green-dot.png" } });
            poiLine = new google.maps.Polyline({ path: [centerPoint, place.geometry.location], geodesic: true, strokeColor: '#22c55e', strokeOpacity: 0.8, strokeWeight: 2 });
            poiLine.setMap(map);

            const content = `<div class="p-2"><p class="font-bold">${place.name}</p><p class="text-xs text-gray-600">${place.vicinity}</p><div id="street-view" class="w-full h-24 mt-2 bg-gray-200 rounded"></div></div>`;
            poiInfoWindow.setContent(content);
            poiInfoWindow.open(map, poiMarker);

            new google.maps.StreetViewPanorama(document.getElementById("street-view"), { position: place.geometry.location, pov: { heading: 34, pitch: 10 }, addressControl: false, linksControl: false, panControl: false, enableCloseButton: false, zoomControl: false, visible: true });
        }
        
        function calculateAndDisplayScore(area, poiCounts) { /* ... same logic ... */ }

        // --- AI-POWERED FUNCTIONS ---
        async function getSellerPitch() {
             if (!lastSearchedPlace) return;
            const btn = document.getElementById('generate-pitch-button');
            const contentDiv = document.getElementById('seller-pitch-content');
            const loader = document.getElementById('seller-loading');
            btn.classList.add('hidden');
            loader.classList.remove('hidden');
            contentDiv.innerHTML = '';
            
            try {
                const address = lastSearchedPlace.formatted_address;
                const prompt = `Generate a compelling real estate agent pitch for a property owner at "${address}". Highlight the key selling points based on market data. Use this format exactly:\n\n**Market Snapshot:**\n- [Point about current market favorability]\n\n**Key Strengths of Your Property:**\n- [Point about location]\n- [Point about nearby amenities]\n\n**Our Marketing Strategy:**\n- [Point about reaching buyers]\n- [Point about pricing strategy]`;
                const resultText = await callGemini(prompt);
                displayFormattedSummary(resultText, contentDiv);
            } catch (error) {
                handleAiError(error, contentDiv, btn);
            } finally {
                loader.classList.add('hidden');
            }
        }
        
        async function getFeasibilitySummary() { /* ... same logic ... */ }
        async function getMarketValueEstimate() { /* ... same logic ... */ }
        async function callGemini(prompt) { /* ... same logic ... */ }
        function displayFormattedSummary(text, container) { /* ... same logic ... */ }

        // --- PDF GENERATION ---
        async function generatePDF() {
            const panelToPrint = document.querySelector('.analysis-panel:not(.hidden)');
            if (!panelToPrint) { alert("Please complete an analysis first."); return; }
            const agentName = document.getElementById('agent-name').value || 'N/A';
            const agentContact = document.getElementById('agent-contact').value || 'N/A';
            const reportDate = new Date().toLocaleDateString();
            const canvas = await html2canvas(panelToPrint, { scale: 2 });
            const imgData = canvas.toDataURL('image/png');
            const pdf = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = pdf.internal.pageSize.getHeight();
            const margin = 10;
            pdf.setFontSize(18);
            pdf.setFont("helvetica", "bold");
            pdf.text("Property Analysis Report", pdfWidth / 2, margin + 5, { align: "center" });
            const imgProps = pdf.getImageProperties(imgData);
            const imgHeight = (imgProps.height * (pdfWidth - margin * 2)) / imgProps.width;
            pdf.addImage(imgData, 'PNG', margin, margin + 15, pdfWidth - margin * 2, imgHeight);
            const footerY = pdfHeight - margin;
            pdf.setFontSize(8);
            pdf.setFont("helvetica", "normal");
            pdf.text(`Report generated on: ${reportDate}`, margin, footerY);
            pdf.text(`Prepared by: ${agentName}`, pdfWidth / 2, footerY, { align: "center" });
            pdf.text(`Contact: ${agentContact}`, pdfWidth - margin, footerY, { align: "right" });
            pdf.save("Property_Analysis_Report.pdf");
        }


        // --- UTILITIES & ERROR HANDLING ---
        function showNotification(message, type = 'info') { /* ... same logic ... */ }
        function handleAiError(error, container, button){ /* ... same logic ... */ }
        function handleApiError(status, category) { /* ... same logic ... */ }

        function clearSelection(calledFromSwitch = false) {
            if (selectedShape) { selectedShape.setMap(null); selectedShape = null; }
            if (addressMarker) { addressMarker.setMap(null); addressMarker = null; }
            if (poiMarker) { poiMarker.setMap(null); poiMarker = null; }
            if (poiLine) { poiLine.setMap(null); poiLine = null; }
            lastSearchedPlace = null;
            
            document.querySelectorAll('.analysis-panel').forEach(p => p.classList.add('hidden'));
            document.getElementById('clear-button').classList.add('hidden');
            document.getElementById('instructions').classList.remove('hidden');

            if (!calledFromSwitch) {
                 setAnalysisMode('property');
            }
        }
        
        function loadMapScript() { /* ... same logic ... */ }

    </script>
</body>
</html>
